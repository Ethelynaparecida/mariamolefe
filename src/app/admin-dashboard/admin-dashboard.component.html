<div class="admin-container">

  <h2>Painel de Controle Maria Mole</h2>

  <div class="container mt-4">

    <div *ngIf="errorVideoId" class="alert alert-danger mb-4 shadow-sm" role="alert"
      style="border-left: 5px solid #dc3545;">
      <h4 class="alert-heading">丘멆잺 A칞칚o Necess치ria: Erro no Player</h4>
      <p><strong>Usu치rio:</strong> {{ errorUserName || 'Desconhecido' }}</p>
      <p><strong>Erro:</strong> {{ errorMessage }}</p>
      <hr>
      <div class="d-flex">
        <button (click)="skipOnError()" class="btn btn-warning me-2">
          <i class="fas fa-forward"></i> Pular e Resolver
        </button>
        <button (click)="openVideoInNewTab()" class="btn btn-outline-danger">
          <i class="fab fa-youtube"></i> Ver no YouTube
        </button>
      </div>
    </div>

    <div [class.ui-bloqueada]="errorVideoId">

      <div class="panels-wrapper">
        <div class="panel controls-panel">
          <h3>Fila de M칰sicas (Total: {{ queueView.length }})</h3>
          <h3>Controles</h3>

          <div class="button-group">
            <button *ngIf="!isPaused" class="btn-pause" (click)="pause()">
              Pausar Player
            </button>
            <button *ngIf="isPaused" class="btn-play" (click)="play()">
              Continuar Player
            </button>
            <button class="btn-restart" (click)="restart()" [disabled]="!currentSong">
              Recome칞ar M칰sica
            </button>
            <button class="btn-skip" (click)="skip()" [disabled]="!currentSong">
              Pular M칰sica Atual
            </button>
            <button *ngIf="!isQueueLocked" class="btn-lock" (click)="lockQueue()">Bloquear Fila</button>
            <button *ngIf="isQueueLocked" class="btn-unlock" (click)="unlockQueue()">Desbloquear Fila</button>
          </div>
        </div>

        <div class="links-section">
          <a href="/player" target="_blank" class="btn-link btn-tv">
            游닠 Abrir tela do video(Player)
          </a>
          <a routerLink="/admin/log" class="btn-link btn-log">
            游늶 Ver Hist칩rico de M칰sicas (칔ltimas 4h)
          </a>
          <a routerLink="/admin/users" class="btn-link btn-users">
            游녻 Ver Lista de Usuarios
          </a>
        </div>
      </div>

      <div class="panel queue-panel">
        <h3>Fila de M칰sicas</h3>
        <div class="queue-section">
          <h4>A Tocar Agora</h4>
          <div *ngIf="currentSong; else filaVazia" class="queue-item current">
            <span class="q-title" [innerHTML]="currentSong.titulo"></span>
            <span class="q-user"> por {{ currentSong.nomeUsuario }}</span>
          </div>
        </div>
        <div class="queue-section">
          <h4>Pr칩ximas na Fila</h4>
          <div *ngIf="upcomingSongs.length > 0; else proximasVazia">
            <ol class="queue-list">
              <li *ngFor="let song of upcomingSongs" class="queue-item">
                <span class="q-title" [innerHTML]="song.titulo"></span>
                <span class="q-user"> por {{ song.nomeUsuario }}</span>
              </li>
            </ol>
          </div>
        </div>
        <ng-template #filaVazia>
          <p class="empty-text">A fila de m칰sicas est치 vazia.</p>
        </ng-template>
        <ng-template #proximasVazia>
          <p class="empty-text">Nenhuma m칰sica na fila de espera.</p>
        </ng-template>
      </div>

      <div class="panel search-panel">
        <h3>Adicionar M칰sica (Admin)</h3>
        <p>Adicione uma m칰sica para um convidado.</p>

        <form [formGroup]="adminSearchForm">
          <div class="form-group">
            <label for="nomeConvidado">Nome do Convidado:</label>
            <input id="nomeConvidado" type="text" formControlName="nome" placeholder="Ex: Jo칚o Silva">
            <div *ngIf="adminSearchForm.get('nome')?.invalid && adminSearchForm.get('nome')?.touched"
              class="error-message">
              칄 preciso preencher o nome antes de continuar.
            </div>
          </div>

          <div class="form-group search-bar" (click)="onDisabledClick()">
            <input type="text" formControlName="query" placeholder="Buscar m칰sica..."
              [disabled]="adminSearchForm.get('nome')?.invalid ?? true">
            <button (click)="onAdminSearch($event)"
              [disabled]="adminSearchForm.get('nome')?.invalid || adminSearchForm.get('query')?.value === '' || isSearching">
              <span *ngIf="!isSearching">Buscar</span>
              <span *ngIf="isSearching">...</span>
            </button>
          </div>

          <div class="divider-text">ou</div>

          <div class="form-group search-bar" (click)="onDisabledClick()">
            <input type="text" formControlName="videoUrl" placeholder="Cole a URL do YouTube..."
              [disabled]="adminSearchForm.get('nome')?.invalid ?? true">
            <button (click)="onAdminAddByUrl($event)"
              [disabled]="adminSearchForm.get('nome')?.invalid || adminSearchForm.get('videoUrl')?.invalid || isAddingByUrl">
              <span *ngIf="!isAddingByUrl">Adicionar</span>
              <span *ngIf="isAddingByUrl">...</span>
            </button>
          </div>
        </form>

        <div class="results-container mt-6">

          <div *ngIf="adminSearchResults && adminSearchResults.length > 0" class="row">
          
          <div *ngFor="let video of adminSearchResults" 
               class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="border rounded p-2 h-100" 
                 style="display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; margin: 5px;
    padding: 2px;
    border: #ece7e7 1px solid;
    border-radius: 5px;">
              <img [src]="video.snippet.thumbnails.default.url" alt="Capa" 
                   style="width: auto; height: 60px; object-fit: cover; border-radius: 4px;">
              
              <div style="min-width: 0;"> 
                <h6 class="mb-0 text-truncate" title="{{ video.snippet.title }}">
                    {{ video.snippet.title }}
                </h6>
                <small class="text-muted text-truncate d-block">
                  {{ video.snippet.channelTitle }}
                </small>
              </div>
              <button class="btn btn-sm add-button" (click)="onAdminAddSong(video)">
                 Adicionar
              </button>
            </div>
            
          </div>

        </div>

          <div *ngIf="hasSearched && (!adminSearchResults || adminSearchResults.length === 0)"
            class="text-center text-muted mt-3">
            <p>Nenhum v칤deo encontrado para essa busca.</p>
          </div>

        </div>
      </div>

      <div class="quota-section">
        <h4>Uso da Cota (Di치rio)</h4>
        <div *ngIf="!quotaUsage" class="loading-quota">A carregar...</div>
        <div *ngIf="quotaUsage">
          <p>Unidades Usadas: <strong>{{ quotaUsage.unidadesUsadas }} / {{ quotaUsage.limiteDiario }}</strong></p>
          <progress [value]="quotaUsage.unidadesUsadas" [max]="quotaUsage.limiteDiario"></progress>
          <p class="buscas-restantes">Buscas Restantes: <strong>~{{ quotaUsage.buscasRestantesEstimadas }}</strong></p>
        </div>
      </div>

    </div>
  </div>
  <div *ngIf="feedbackMessage" class="feedback">
    {{ feedbackMessage }}
  </div>
</div>